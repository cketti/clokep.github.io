<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Why Rewrite IRC into JavaScript? (vs. libpurple’s vs. ChatZilla’s)</title>
        <link rel="stylesheet" href="http://patrick.cloke.us/theme/css/main.css" />
        <link href="http://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Like bricks in the sky Atom Feed" />
        <link href="http://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Like bricks in the sky RSS Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://patrick.cloke.us/">Like bricks in the sky </a></h1>
                <nav><ul>
                    <li><a href="http://patrick.cloke.us/pages/about.html">About</a></li>
                    <li><a href="http://patrick.cloke.us/pages/contact.html">Contact</a></li>
                    <li class="active"><a href="http://patrick.cloke.us/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->

        <div id="container" class="body">
        <section id="extras">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            <li><a href="http://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate">rss feed</a></li>

                            <li><a href="https://www.twitter.com/clokep">twitter</a></li>
                            <li><a href="https://bitbucket.org/clokep">bitbucket</a></li>
                            <li><a href="https://www.github.com/clokep">github</a></li>
                            <li><a href="https://mozillians.org/clokep">mozillians</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://patrick.cloke.us/posts/2010/Dec/08/why-rewrite-irc-into-javascript-vs-libpurples-vs-chatzillas/" rel="bookmark"
           title="Permalink to Why Rewrite IRC into JavaScript? (vs. libpurple’s vs. ChatZilla’s)">Why Rewrite <span class="caps">IRC</span> into JavaScript? (vs. libpurple&#8217;s vs.&nbsp;ChatZilla&#8217;s)</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2010-12-08T18:29:00">
                Published: 12/08/2010 06:29 PM UTC
        </abbr>

<p>In <a href="http://patrick.cloke.us/category/misc.html">misc</a>. </p>
<p>tags: <a href="http://patrick.cloke.us/tag/instantbird.html">Instantbird</a> <a href="http://patrick.cloke.us/tag/irc.html">IRC</a> <a href="http://patrick.cloke.us/tag/mozilla.html">Mozilla</a> <a href="http://patrick.cloke.us/tag/programming.html">programming</a> </p>
</footer><!-- /.post-info -->      <p>I had a request on <span class="caps">IRC</span> (from Mic) to write an in-depth blog post
about <a class="reference external" href="https://bugzilla.instantbird.org/show_bug.cgi?id=507"><span class="caps">IRC</span> in JavaScript</a>:</p>
<blockquote>
&quot;Maybe we could ask clokep if he&#8217;d like to write something about
js-irc? Why it is done, what the advantages are once it&#8217;s done, how
he is working on it (going through the specs), putting the
jsProtocol code to test and adding missing pieces?&quot; &#8212; <a class="reference external" href="http://log.bezut.info/instantbird/101208/#m54">Mic</a></blockquote>
<div class="section" id="wait-a-second-what-is-irc">
<h2>Wait a second, what is <span class="caps">IRC</span>?</h2>
<p>I guess this is a good first question, I&#8217;ll steal from <a class="reference external" href="http://en.wikipedia.org/wiki/IRC">Wikipedia</a>:</p>
<blockquote>
Internet Relay Chat (<span class="caps">IRC</span>) is a form of real-time [&#8230;] chat [&#8230;] It
is mainly designed for group communication [&#8230;] but also allows
[&#8230;for&#8230;] private message as well as chat and data transfers.</blockquote>
<p>Awesome, what&#8217;s that really mean?&nbsp; It&#8217;s an instant messaging protocol
with an actual specification (i.e. it&#8217;s not owned by some large, unnamed
company), with open-source libraries for clients and servers.&nbsp; It&#8217;s
usually used by more computer-oriented types of people and centers
around group conversation.&nbsp; Personally most of what I use it for is
open-source software I use (I&#8217;m almost always in <a class="reference external" href="irc://irc.mozilla.org/#instantbird">#instantbird</a>,
<a class="reference external" href="irc://irc.mozilla.org/#maildev">#maildev</a>, and <a class="reference external" href="irc://irc.mozilla.org/#songbird">#songbird</a> on <a class="reference external" href="http://irc.mozilla.org/">Mozilla&#8217;s <span class="caps">IRC</span> servers</a>.)</p>
</div>
<div class="section" id="why-it-is-done-what-advantages-are-there-once-this-is-done">
<h2>Why it is done?&nbsp; What advantages are there once this is&nbsp;done?</h2>
<p>I touched upon this a little in my <a class="reference external" href="http://patrick.cloke.us/posts/2010/Dec/04/javascript-irc-in-instantbird/">last post</a>.&nbsp; In terms of
Instantbird: there&#8217;s an idea of switching some / all of the protocols
(eventually) to be JavaScript protocols instead of the libpurple
versions (libpurple is written mostly in C and is cross-platform, but
recent gains in speed in JavaScript allow this advantage of libpurple to
not matter as much).&nbsp; This would unfortunately mean we need to maintain
a lot more code, but it would allow us to integrate protocols in any way
that we see fit, instead of only using APIs / methods provided by
libpurple.&nbsp; Hopefully this would allow us to <a class="reference external" href="https://bugzilla.instantbird.org/showdependencytree.cgi?id=507&amp;maxdepth=2&amp;hide_resolved=1">enhance our <span class="caps">IRC</span>
implementation</a> a&nbsp;bit.</p>
<p>Also, Instantbird (nightlies) currently have limited support for
generating a protocol plug-in in JavaScript.&nbsp; A couple of &quot;test&quot;
protocols have be done, but nothing in &quot;real&quot; (in particular, none that
used a multi-user chat).&nbsp; This would allow us to iron out <a class="reference external" href="https://bugzilla.instantbird.org/show_bug.cgi?id=519">some</a>
<a class="reference external" href="https://bugzilla.instantbird.org/show_bug.cgi?id=118">bugs</a> in the implementation of JavaScript&nbsp;protocols.</p>
<p><em>[Edit: Florian suggested another question that wasn&#8217;t originally
covered, which some people more familiar with Mozilla code might be&nbsp;wondering.]</em></p>
</div>
<div class="section" id="why-aren-t-you-using-the-code-from-chatzilla">
<h2>Why aren&#8217;t you using the code from&nbsp;ChatZilla?</h2>
<p>This was a tough one.&nbsp; Honestly when I first wanted a parsing
algorithm, I looked at the ChatZilla code, I used it.&nbsp; Then rewrote it
in a fourth as many lines (<a class="reference external" href="http://hg.mozilla.org/chatzilla/file/tip/js/lib/irc.js#l1250">93</a> vs. <a class="reference external" href="https://hg.instantbird.org/experiments/file/IRC-JavaScript/components/ircProtocol.js#l208">20</a>).&nbsp; Simply said, the code in
ChatZilla is <em>old</em>, it doesn&#8217;t use many of the features available only
in newer versions of JavaScript.&nbsp; To that point, the ChatZilla code
hasn&#8217;t been updated in over a year!&nbsp; The last check-in was: 2009-10-03,
below is a <a class="reference external" href="http://hg.mozilla.org/chatzilla/log/tip/js/lib/irc.js">quick summary</a> of the number of check-ins per&nbsp;year:</p>
<ul class="simple">
<li>2010:&nbsp;0</li>
<li>2009:&nbsp;5</li>
<li>2008:&nbsp;15</li>
<li>2007:&nbsp;11</li>
<li>2006:&nbsp;18</li>
</ul>
<p>There&#8217;s been a pretty steady decline in check-ins.&nbsp; I could take this
code and attempt to whip it into shape and make huge sweeping changes
and commit them back to ChatZilla, but honestly it was easier to start
over for me.&nbsp; Regardless of ease, I&#8217;m not sure it would work any:
especially since the ChatZilla code seems overly complicated and overly
specific (since it wasn&#8217;t really built as a library as far as I can
see), especially since all the code is meant to deal only with <span class="caps">IRC</span>.&nbsp; The
Instantbird code needs to be protocol agnostic to a degree, while is why
it interfaces to&nbsp;purplexpcom.</p>
<p>A quick example of this is: ChatZilla uses a CIRCUser object, but for
Instantbird I need to create either an imIContact or a
purpleIAccountBuddy (depending on the situation).&nbsp; It&#8217;s possible that&#8217;s
can be abstracted and code shared &#8212; but I&#8217;m not sure it would be worth
the effort.&nbsp; After all this, I should probably look more into the
ChatZilla code, perhaps more of it could be&nbsp;used.</p>
<p>(If someone familiar with the ChatZilla code base &#8212; I don&#8217;t know
who/if there&#8217;s a maintainer &#8212; is interested in talking with me, please
get in contact here or on #instantbird.&nbsp; It&#8217;s possible we could align
some of what I&#8217;ve been working on, but I&#8217;m not sure how much could be
shared besides the parsing&nbsp;algorithm).</p>
<p><em>[End&nbsp;edit]</em></p>
</div>
<div class="section" id="what-are-the-specific-advantages-for-an-end-user">
<h2>What are the specific advantages for an&nbsp;end-user?</h2>
<p>In terms of the <span class="caps">IRC</span> protocol itself, there shouldn&#8217;t be any, my goal
is for it to be a drop in replacement for the libpurple implementation
with automatic account migration, etc. For end-users we can hopefully
solve <a class="reference external" href="https://bugzilla.instantbird.org/showdependencytree.cgi?id=574&amp;maxdepth=1&amp;hide_resolved=1">a few annoying <span class="caps">IRC</span> <span class="caps">UI</span> issues</a>.</p>
</div>
<div class="section" id="what-about-for-developers-anything-cool-there">
<h2>What about for developers?&nbsp; Anything cool&nbsp;there?</h2>
<p>Well, I&#8217;m hoping to be able to test this replacement via an extension
that replaces the libpurple <span class="caps">IRC</span> to dogfood it before eventual inclusion
in Instantbird.&nbsp; I&#8217;m not sure if that counts as &quot;cool.&quot; though.&nbsp; If
nothing else there will be an example of how to write a protocol in
JavaScript (using sockets).&nbsp; So hopefully other people can make some
other cool protocols off of that example.&nbsp; You might wonder what else we
have planned for JavaScript protocols; there are plans to make at least
a Twitter&nbsp;protocol.</p>
</div>
<div class="section" id="how-is-this-being-done">
<h2>How is this being&nbsp;done?</h2>
<p>Well I said up above <span class="caps">IRC</span> has a specification, right?&nbsp; Well, yes.
There&#8217;s the <a class="reference external" href="http://tools.ietf.org/html/rfc1459">original specification</a>, this was superseded by <a class="reference external" href="http://tools.ietf.org/html/rfc2810">four</a>
<a class="reference external" href="http://tools.ietf.org/html/rfc2811">different</a> <a class="reference external" href="http://tools.ietf.org/html/rfc2812">specification</a> <a class="reference external" href="http://tools.ietf.org/html/rfc2813">documents</a>.&nbsp; Of which we only really
care about one: <a class="reference external" href="http://tools.ietf.org/html/rfc2812">the client protocol</a>.&nbsp; So we have this updated
specification (try reading it, it&#8217;s rather painful), which is good.
It&#8217;s relatively straightforward set of commands and responses/errors.
It&#8217;s a bit more confusing than that though since there are a couple of
extensions, etc.&nbsp; This is summarized&nbsp;below:</p>
<ul class="simple">
<li>[<span class="caps">STRIKEOUT</span>:<span class="caps">RFC</span> 1459]<ul>
<li>Extended with <a class="reference external" href="http://www.irchelp.org/irchelp/rfc/dccspec.html">[<span class="caps">STRIKEOUT</span>:<span class="caps">DCC</span> specification (&quot;direct client-to-client&quot;)]</a><ul>
<li>Replaced with [<span class="caps">STRIKEOUT</span>:<a class="reference external" href="http://www.irchelp.org/irchelp/rfc/dccspec.html"><span class="caps">CTCP</span> (&quot;client-to-client protocol&quot;)</a>]<ul>
<li><a class="reference external" href="http://www.invlogic.com/irc/ctcp.html">Draft for a formalized <span class="caps">CTCP</span></a></li>
</ul>
</li>
<li>(Apparently some people are working on a <a class="reference external" href="http://www.dcc2.org/"><span class="caps">DCC2</span></a>)</li>
</ul>
</li>
<li>Officially replaced with RFCs 2810, 2811, 2812,&nbsp;2813</li>
</ul>
</li>
</ul>
<p>A lot of this is being done by reading the specifications and finding
the proper responses, etc.&nbsp; I&#8217;ve also used <a class="reference external" href="http://www.wireshark.org/download.html">Wireshark</a> a bit to see how
libpurple sends <span class="caps">IRC</span> commands (in particular, in what order it sends them
in).&nbsp; A lot of my development is happening on live <span class="caps">IRC</span> servers, which
isn&#8217;t really best practice, but I&#8217;m mostly sending commands by hand to
see the responses since a bunch of non-standard responses and extensions
have developed beyond the above.&nbsp; I have been using <a class="reference external" href="http://ircd.bircd.org/">beware irc</a> to run
a daemon on my own machine,&nbsp;however.</p>
</div>
<div class="section" id="so-how-far-along-are-you">
<h2>So how far along are&nbsp;you?</h2>
<p>I&#8217;ve started implementing <span class="caps">RFC</span> 2812 and have a variety of commands done
(the login sequence occurs automatically, the server connection is kept
alive, messages can be sent to a channel and are parsed when received, a
lot of the initial server information is displayed but unparsed).&nbsp; But
there&#8217;s a lot more to do!&nbsp; As my last post outlined, I recently was able
to successfully get a chat to work in Instantbird from a silly bug I had
been&nbsp;having.</p>
<p>It&#8217;s rather slow going since I&#8217;ll start to implement something from
the <span class="caps">IRC</span> side, and then realize the <a class="reference external" href="http://hg.instantbird.org/instantbird/file/tip/purple/purplexpcom/src/jsProtoHelper.jsm">Instantbird layer</a> (the jsProtocol
module) is missing a component I need.&nbsp; One of the major parts of
working on this is extending the Instantbird layer to contain the proper
functions and objects needed to implement chats via JavaScript.&nbsp; This is
usually the slowest going part of my code, since it involves interfacing
with Instantbird / <a class="reference external" href="http://hg.instantbird.org/instantbird/file/tip/purple/purplexpcom/public/">purplexpcom</a>.&nbsp; Luckily Florian, the main developer
of Instantbird, has been a big help with this (as have other
participants of #instantbird &#8212; in particular I know Mic helped track
down a few syntax type&nbsp;bugs).</p>
</div>
<div class="section" id="what-s-next">
<h2>What&#8217;s&nbsp;next?</h2>
<p>Now that have the basics of chat working, I need to start handling the
<span class="caps">QUIT</span>, <span class="caps">PART</span> and <span class="caps">JOIN</span> commands for when other users enter <span class="amp">&amp;</span> leave chat
rooms.&nbsp; Once these are complete it should be quite usable, although the
entire preference system still doesn&#8217;t exist, including notifying the <span class="caps">UI</span>
of what options are available.&nbsp; In addition, I need to look into doing
<span class="caps">SSL</span>&nbsp;sockets.</p>
<p>Once the protocol plug-in is done, we plan to abstract sections of it
that will be useful for other protocols (in particular the socket
connection&nbsp;aspects).</p>
</div>
<div class="section" id="where-can-i-see-this-stuff">
<h2>Where can I see this&nbsp;stuff&#8230;?</h2>
<p>My work is kept in the &quot;<a class="reference external" href="https://hg.instantbird.org/experiments/file/IRC-JavaScript/">experiments</a>&quot; repository on Instantbird&#8217;s
<a class="reference external" href="http://mercurial.selenic.com/">Mercurial</a> repository.&nbsp; There&#8217;s also a variety of bugs open (they&#8217;re
listed above, I&#8217;m not going to re-list them), although not a ton is
happening in&nbsp;them.</p>
</div>
<div class="section" id="how-can-i-help">
<h2>How can I&nbsp;help?!</h2>
<p>Well you can of course feel free to download the code and hack on it,
let me know (via <span class="caps">IRC</span> or any of the bugs most likely) if you have a patch
you&#8217;d like me to apply.&nbsp; Or if you just found something that doesn&#8217;t
work you can feel free to let me know, although I probably just haven&#8217;t
gotten around to fixing it&nbsp;yet.</p>
<p>Also, if you&#8217;ve ever found something annoying / broken in the <span class="caps">IRC</span>
implementation in Instantbird / libpurple please let us know (through
any of the above contact&nbsp;sources).</p>
<p>Hopefully that&#8217;s a bit of a better explanation of why we&#8217;re spending
time to rewrite the <span class="caps">IRC</span> protocol implementation into JavaScript &#8212; we
definitely think it&#8217;s worth it and can lead to a bunch of new unique
protocol plug-ins for&nbsp;Instantbird.</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>


        </div>

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-52389517-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>