<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>IRC Auto-Performs</title>
    <link rel="stylesheet" href="http://patrick.cloke.us/theme/css/main.css" />
    <link href="http://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Like bricks in the sky Atom Feed" />
    <link href="http://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Like bricks in the sky RSS Feed" />

    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body id="index" class="home">
    <header id="banner" class="body">
        <h1><a href="http://patrick.cloke.us/">Like bricks in the sky </a></h1>
        <nav><ul>
            <li><a href="http://patrick.cloke.us/pages/about.html">About</a></li>
            <li><a href="http://patrick.cloke.us/pages/contact.html">Contact</a></li>
            <li><a href="http://patrick.cloke.us/archives.html">Archives</a></li>
            <li><a href="http://patrick.cloke.us/tags.html">Tags</a></li>
        </ul></nav>
    </header><!-- /#banner -->

    <div id="container" class="body">
        <section id="extras" class="left">
            <div class="social">
                <h2>social</h2>
                <ul>
                    <li><a href="https://www.twitter.com/clokep" target="_blank">twitter</a></li>
                    <li><a href="https://bitbucket.org/clokep" target="_blank">bitbucket</a></li>
                    <li><a href="https://www.github.com/clokep" target="_blank">github</a></li>
                    <li><a href="https://mozillians.org/u/clokep/" target="_blank">mozillians</a></li>

                    <li><a href="http://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                    <li><a href="http://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate">rss feed</a></li>
                </ul>
            </div><!-- /.social -->
        </section><!-- /#extras -->

        <section id="search" class="left">
            <h2>search</h2>

            <form method="get" action="http://www.google.com/search" target="_blank">

                <input type="text" name="q" placeholder="search this site" />
                <input type="submit" value="Search" />
                <input type="hidden"  name="sitesearch" value="patrick.cloke.us" />
            </form>
        </section>


<section id="toc" class="left">
    <h2>table of contents</h2>
    <div class="toc" id="">

<ul class="simple">
<li><a class="reference internal" href="#design" id="id1">Design</a></li>
<li><a class="reference internal" href="#messages" id="id2">Messages</a></li>
<li><a class="reference internal" href="#handlers" id="id3">Handlers</a></li>
</ul>
</div>
</section>

<section id="content" class="body">
  <article>
    <header>
        <h1 class="entry-title">
            <a href="http://patrick.cloke.us/posts/2012/06/11/irc-auto-performs/" rel="bookmark"
               title="Permalink to IRC Auto-Performs"><span class="caps">IRC</span>&nbsp;Auto-Performs</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info-container">
    <div class="post-info-top">
    </div>

    <!-- Second div is to change the background color again. -->
    <div class="post-info-bg">
    <div class="post-info">
        <div id="gravatar" style="background-image: url('http://www.gravatar.com/avatar/130405f65521b6ee6bbbe0204070a163');">
        </div>

        <abbr class="published" title="2012-06-11T22:25:00">
            Published: 06/11/2012 10:25 PM EST
        </abbr>

        <address class="vcard author">
            By                 <a class="url fn" href="http://patrick.cloke.us/pages/about.html">Patrick Cloke</a>
        </address>


        <div id="gravatar-clear"></div>

        <div id="tag-list">
            tags:                 <a href="http://patrick.cloke.us/tag/instantbird.html">Instantbird</a>
                <a href="http://patrick.cloke.us/tag/irc.html">IRC</a>
                <a href="http://patrick.cloke.us/tag/mozilla.html">Mozilla</a>
        </div>

        

        <div id="post-share-links" class="social">
            share:
            <a href="http://twitter.com/home?status=IRC%C2%A0Auto-Performs%20http%3A//patrick.cloke.us/posts/2012/06/11/irc-auto-performs/" target="_blank" title="Share on Twitter">Twitter</a>
            <a href="http://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=http%3A//patrick.cloke.us/posts/2012/06/11/irc-auto-performs/" target="_blank" title="Share on Facebook">Facebook</a>
            <a href="https://plus.google.com/share?url=http%3A//patrick.cloke.us/posts/2012/06/11/irc-auto-performs/" target="_blank" title="Share on Google Plus">Google+</a>
            <a href="mailto:?subject=IRC%C2%A0Auto-Performs&amp;body=http%3A//patrick.cloke.us/posts/2012/06/11/irc-auto-performs/" target="_blank" title="Share via Email">Email</a>
        </div>
    </div>
    </div>

    <div class="post-info-bottom">
    </div>
</footer><!-- /.post-info -->        
<p>There have been a <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=742675">few</a> <a class="reference external" href="https://bugzilla.instantbird.org/show_bug.cgi?id=1101">requests</a> to support "auto-performs"
(sending commands to the <span class="caps">IRC</span> server after connection that the user types
into a box or whatever). Personally I find this to be:</p>
<ol class="arabic simple">
<li>A fairly awful user experience.</li>
<li>Confusing to new users.</li>
<li>Unnecessary.</li>
</ol>
<p>I additionally don’t like this idea since it requires us to have
commands for all the common tasks you’d want to do in an auto-perform
(or support sending absolutely raw messages to the server, which we
actually do already in the /quote command). Essentially what I just
described is writing our own scripting language…that seems pointless
(and frankly, I have better things to do). I’m hoping to convince you
with this post (and maybe a series of posts) that auto-performs aren’t
necessary and a trivial restartless extension can replace them.</p>
<div class="section" id="design">
<h2><a class="toc-backref" href="#id1">Design</a></h2>
<p>Part of the desire to <a class="reference external" href="http://patrick.cloke.us/posts/2011/04/30/why-rewrite-irc-protocol-plugin-part-2/">replace the libpurple <span class="caps">IRC</span> protocol plugin</a>
with a new JavaScript one built specifically for Instantbird (which is
also now used in Thunderbird!) was to make the protocol fully
extensible. There are <a class="reference external" href="http://patrick.cloke.us/posts/2011/03/08/so-called-irc-specifications/">many revisions and unofficial extensions to <span class="caps">IRC</span></a>
and we might not necessarily want to support them all (especially if
they only apply to a single network). Allowing all parts of the protocol
implementation to be touched and extended seemed like a great way to
handle this.</p>
<p>Initially I tried to do this by making the <span class="caps">IRC</span> account into an <span class="caps">XPCOM</span>
component (well it is one already, it’s an prplIAccount, but I meant an
<span class="caps">IRC</span> specific one: implementing ircIAccount, if you will). Unfortunately,
this seemed to have a lot of overhead and got complicated extremely
quickly. Anything I’d want to touch from a message handler (wait,
wait…what’s a handler?! I’ll get back to that) would need to have
methods written and exposed to access internal data of the
account…does that sound very extensible to you? Well, it doesn’t to me…</p>
<p>Onto design two! (Well actually my first design…) Lots of JavaScript
objects! The entire protocol is implemented as a set of JavaScript
objects and the handlers directly touch and modify the account’s data
(of course there’s methods for abstraction, etc.). This means that an
extension has absolutely <span class="caps">FULL</span> access to every about an account…this
also means an extension could seriously mess with and cause the protocol
to stop working or do really crazy things, etc. Unfortunately there
isn’t really a way to avoid that. Hopefully people write good code.</p>
</div>
<div class="section" id="messages">
<h2><a class="toc-backref" href="#id2">Messages</a></h2>
<p>I’m going to go into an aside about messages right now, even though it
doesn’t quite seem relevent yet. It will. <span class="caps">IRC</span> has a bunch of
sub-protocols embedded within the <span class="caps">IRC</span> protocol (see the link above about
unofficial extensions). We attempt to parse all the string messages and
make pretty JavaScript objects out of them. I’ve actually identified
five (yes, count that: five) different sub-"protocols" within <span class="caps">IRC</span> that
we deal:</p>
<ol class="arabic simple">
<li><span class="caps">IRC</span> itself (i.e. <a class="reference external" href="http://tools.ietf.org/html/rfc1459"><span class="caps">RFC</span> 1459</a> / <a class="reference external" href="http://tools.ietf.org/html/rfc2812"><span class="caps">RFC</span> 2812</a> / various numeric extensions)</li>
<li><a class="reference external" href="http://www.irchelp.org/irchelp/rfc/ctcpspec.html"><span class="caps">CTCP</span> (the Client-to-Client Protocol)</a>,embedded in <span class="caps">PRIVMSG</span> commands
of <span class="caps">IRC</span></li>
<li><span class="caps">DCC</span> (Direct Client-to-Client), a subprotocol of <span class="caps">CTCP</span></li>
<li><a class="reference external" href="http://tools.ietf.org/html/draft-brocklesby-irc-isupport-03"><span class="caps">ISUPPORT</span></a> (also known as Numeric 005), a method of negotiating
capabilities between a client and server</li>
<li>And finally, handling of <span class="caps">IRC</span> Services (there’s a lot of them and no
specification, but we treat them specially)</li>
</ol>
<p>Briefly what happens when we receive a raw message over the wire, we
create an <a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/irc.js#l14">ircMessage object out of it using a variety of regular
expressions</a>. This object has a variety of fields (see the link for
details), including the command, who sent the message and the parameters.</p>
<p>If the message is identified as a <span class="caps">CTCP</span> message, we then morph the
ircMessage into a <a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/ircCTCP.jsm#l44">CTCPMessage</a>, which can be morphed into a
<a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/ircDCC.jsm#l20">DCCMessage</a>. Additionally, a 005 reply can be parsed into a
<a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/ircISUPPORT.jsm#l22">isupportMessage</a>. And last, but not least, a received <span class="caps">PRIVMSG</span> can also
be parsed into a <a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/ircServices.jsm#l19">ServiceMessage</a>. Each of these extends the <span class="caps">IRC</span>
message without destroying information. (Yes, I’m realizing now that my
choice of whether to use capitals is all messed up…)</p>
<p>Well, why do we care…? By preparsing the strings into objects (as
defined by any "specifications" that exist), we keep extensions from
having to parse messages over and over again from strings.</p>
</div>
<div class="section" id="handlers">
<h2><a class="toc-backref" href="#id3">Handlers</a></h2>
<p>A handler is simply what I call the object that contains the methods
to deal with an incoming message. Pretty much, you get to say "Only send
me <span class="caps">ISUPPORT</span> messages!" or "Only send me <span class="caps">CTCP</span> messages!" and voila, you
only get that type of message. Each message type has a field that is
used to choose the method to run (for the <span class="caps">IRC</span> messages, the "command",
for <span class="caps">CTCP</span> the "<span class="caps">CTCP</span> command", <span class="caps">ISUPPORT</span> the "parameter", etc.) This sounds
a lot more complicated than it is, I think a brief <a class="reference external" href="https://bitbucket.org/clokep/irc-extras/src/6f778f17172a/example/bootstrap.js">example</a> is in order:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">ircSimpleExample</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// The name here is really only used in error messages.</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">"IRC Simple Example"</span><span class="p">,</span>
  <span class="c1">// Slightly above the default priority so we run before the main IRC handler.</span>
  <span class="nx">priority</span><span class="o">:</span> <span class="nx">ircHandlers</span><span class="p">.</span><span class="nx">DEFAULT_PRIORITY</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
  <span class="c1">// Run this for all accounts (note that the 'this' object in this method is</span>
  <span class="c1">// the JavaScript account object.</span>
  <span class="nx">isEnabled</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">// The commands we want to handle. For each of these, the account object is</span>
  <span class="c1">// bound to 'this' and the single parameter is of the type that you've</span>
  <span class="c1">// registered your handle.</span>
  <span class="nx">commands</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"001"</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aMessage</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// At the 001 response we've successfully connected to the server.</span>
      <span class="c1">// Send an IDENTIFY command to NickServ.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="s2">"PRIVMSG"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"NickServ"</span><span class="p">,</span> <span class="s2">"IDENTIFY &lt;your password&gt;"</span><span class="p">]);</span>

      <span class="c1">// Return false so the default handler still runs.</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Just like that we’ve designed a handler! Whenever the 001 method is
received from the server, this function will run and attempt to identify
with the NickServ (of course this could use a bit more security on it,
but it’s to demonstrate the possibilities). (The sendMessage function
takes the command to send and an array of parameters to send.)</p>
<p>As this is already a long post, I think I’ll cut this off now and
continue this at another time, but I hope I’m beginning to convince you
that allowing directy access to the account and protocol implementation
is a more powerful (and even simpler in many ways, in my opinion)
alternative to "auto-performs". The one major downside I see to this, is
that it requires a bit more understanding of the actual protocol level
implementation, I don’t feel that knowing you need to use "<span class="caps">PRIVMSG</span>" as a
command instead of /msg is a huge issue, however.</p>
</div>

    </div><!-- /.entry-content -->

    <div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'clokep';
    var disqus_identifier = 'irc-auto-performs';
    var disqus_url = 'http://patrick.cloke.us/posts/2012/06/11/irc-auto-performs/';
    var disqus_title = 'IRC Auto-Performs';
    (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//clokep.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
  </article>
</section>
    </div>

    <footer id="contentinfo" class="body">
        <address id="about" class="vcard body">
        Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
        Blog source available on <a href="https://github.com/clokep/clokep.github.io">GitHub</a>.
        </address><!-- /#about -->
    </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-52389517-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    <script src="//static.getclicky.com/js" type="text/javascript"></script>
    <script type="text/javascript">try{ clicky.init(100846713); }catch(e){}</script>
    <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100846713ns.gif" /></p></noscript>
<script type="text/javascript">
    var disqus_shortname = 'clokep';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>