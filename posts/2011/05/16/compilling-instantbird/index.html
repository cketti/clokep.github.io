<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Compiling Instantbird</title>
    <link rel="stylesheet" href="http://patrick.cloke.us/theme/css/main.css" />
    <link href="http://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Like bricks in the sky Atom Feed" />
    <link href="http://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Like bricks in the sky RSS Feed" />

    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body id="index" class="home">
    <header id="banner" class="body">
        <h1><a href="http://patrick.cloke.us/">Like bricks in the sky </a></h1>
        <nav><ul>
            <li><a href="http://patrick.cloke.us/pages/about.html">About</a></li>
            <li><a href="http://patrick.cloke.us/pages/contact.html">Contact</a></li>
            <li><a href="http://patrick.cloke.us/archives.html">Archives</a></li>
            <li><a href="http://patrick.cloke.us/tags.html">Tags</a></li>
        </ul></nav>
    </header><!-- /#banner -->

    <div id="container" class="body">
        <section id="extras" class="left">
            <div class="social">
                <h2>social</h2>
                <ul>
                    <li><a href="http://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                    <li><a href="http://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate">rss feed</a></li>

                    <li><a href="https://www.twitter.com/clokep" target="_blank">twitter</a></li>
                    <li><a href="https://bitbucket.org/clokep" target="_blank">bitbucket</a></li>
                    <li><a href="https://www.github.com/clokep" target="_blank">github</a></li>
                    <li><a href="https://mozillians.org/u/clokep/" target="_blank">mozillians</a></li>
                </ul>
            </div><!-- /.social -->
        </section><!-- /#extras -->

        <section id="search" class="left">
            <h2>search</h2>

            <form method="get" action="http://www.google.com/search" target="_blank">

                <input type="text" name="q" placeholder="search this site" />
                <input type="submit" value="Search" />
                <input type="hidden"  name="sitesearch" value="patrick.cloke.us" />
            </form>
        </section>


<section id="toc" class="left">
    <h2>table of contents</h2>
    <div class="toc" id="">

<ul class="simple">
<li><a class="reference internal" href="#build-requirements" id="id2">Build Requirements:</a><ul>
<li><a class="reference internal" href="#visual-studio-express" id="id3">Visual Studio Express:</a></li>
<li><a class="reference internal" href="#microsoft-windows-sdk" id="id4">Microsoft Windows <span class="caps">SDK</span>:</a></li>
<li><a class="reference internal" href="#microsoft-macro-assembler" id="id5">Microsoft Macro Assembler:</a></li>
<li><a class="reference internal" href="#mozillabuild" id="id6">MozillaBuild:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#checkout-the-code" id="id7">Checkout the Code:</a></li>
<li><a class="reference internal" href="#id1" id="id8">Compiling Instantbird:</a></li>
</ul>
</div>
</section>

<section id="content" class="body">
  <article>
    <header>
        <h1 class="entry-title">
            <a href="http://patrick.cloke.us/posts/2011/05/16/compilling-instantbird/" rel="bookmark"
               title="Permalink to Compiling Instantbird">Compiling&nbsp;Instantbird</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
    <abbr class="published" title="2011-05-16T21:30:00">
        Published: 05/16/2011 09:30 PM EST
    </abbr>

    <address class="vcard author">
        By             <a class="url fn" href="http://patrick.cloke.us/pages/about.html">Patrick Cloke</a>
    </address>

<p>tags: <a href="http://patrick.cloke.us/tag/instantbird.html">Instantbird</a> <a href="http://patrick.cloke.us/tag/mozilla.html">Mozilla</a> <a href="http://patrick.cloke.us/tag/programming.html">programming</a> </p>
</footer><!-- /.post-info -->        
<p>In the past I’ve tried to compile a few different programs that use
the Mozilla toolkit to various levels of success.  I’ve tried to compile
Thunderbird, Songbird and Instantbird at various points.  I got
Thunderbird to compile, but it only worked sporadically (although I
think that was Firefox moving so fast that Thunderbird couldn’t keep
up), Songbird I gave up on rather quickly and Instantbird I’ve tried a
few times.</p>
<p>Last summer I had Instantbird compiling on my old laptop (a Lenovo
T60), which is &gt;5 years old at this point and has had the heatsink / fan
replaced twice — a known issue with that model laptop.  Needless to
say, that laptop didn’t like compiling something on Windows that took
approximately an hour with a large number of reads and writes to the
hard drive.  This mixed with it being an old dual core + a 5400 <span class="caps">RPM</span>
meant I’d be waiting a <span class="caps">LONG</span> time for my code to compile.  I got a
Thinkpad X201 this past summer, so I finally got around to setting up a
development environment on it and was able to get Instantbird to compile
fully today.  I’ve outlined the steps I’ve followed: kind of to mirror
the <a class="reference external" href="https://developer.mozilla.org/En/Simple_Thunderbird_build">Simple Thunderbird Build</a> page on <span class="caps">MDC</span>.</p>
<p>I’ve done this using Microsoft Windows 7 Professional (64-bit) with
Service Pack 1. (4.00 <span class="caps">GB</span> of <span class="caps">RAM</span>, Intel Core i7 M620 2.67 GHz).
Throughout these steps, the defaults locations and options are used in
the installers.</p>
<div class="section" id="build-requirements">
<h2><a class="toc-backref" href="#id2">Build Requirements:</a></h2>
<div class="section" id="visual-studio-express">
<h3><a class="toc-backref" href="#id3">Visual Studio Express:</a></h3>
<p>We need to install Visual Studio Express, specifically <span class="caps">VC8</span> (2005) with
Service Pack 1.  (Mozilla compiles with <span class="caps">VC9</span> and <span class="caps">VC10</span> to various degrees,
but it seems libpurple only compiles with <span class="caps">VC8</span>, also this is what’s on
the Instantbird buildbot, so I like having the same version.)  I
couldn’t find this on Microsoft’s website but I found it on <a class="reference external" href="http://www.softpedia.com/get/Programming/Other-Programming-Files/Microsoft-Visual-C-Toolkit.shtml">Softpedia</a>
(which is a legitimate site).  Anyway, download the installer and
install it (which will download the actual compiler from Microsoft),
ensure that you also install the <span class="caps">IDE</span> (which is checked by default).</p>
<p>This will only install <span class="caps">VC8</span>, the initial release.  We also need to
install <a class="reference external" href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=7b0b0339-613a-46e6-ab4d-080d4d4a8c4e">Service Pack 1</a>.  I personally did this using Windows Update,
but one of the installers from there should also work.</p>
</div>
<div class="section" id="microsoft-windows-sdk">
<h3><a class="toc-backref" href="#id4">Microsoft Windows <span class="caps">SDK</span>:</a></h3>
<p>Specifically we need the <a class="reference external" href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=c17ba869-9671-4330-a63e-1fd44e0e2505&amp;displaylang=en">Windows 7 <span class="caps">SDK</span></a> (for Jumplist, Aero, etc.
support).  Download and install the <span class="caps">SDK</span>, this one took a while for me to
install.  I ate dinner while it was installing (pasta, if you’re curious
— I already had sauce made).</p>
<p>There’s a linker error when using <span class="caps">VC8</span> and the Windows 7 <span class="caps">SDK</span>, so we’ll
need to install a <a class="reference external" href="http://support.microsoft.com/kb/949009/">hotfix</a>for that (I tried without it and I ran into
the issue).  I had to download the "VS80sp1-<span class="caps">KB949009</span>-<span class="caps">IA64</span>-<span class="caps">INTL</span>.exe"
version (there’s also an X86 and an X64 version).  Choose the one that works.</p>
</div>
<div class="section" id="microsoft-macro-assembler">
<h3><a class="toc-backref" href="#id5">Microsoft Macro Assembler:</a></h3>
<p>In order to properly assemble the code we need to <a class="reference external" href="http://www.microsoft.com/downloads/en/details.aspx?familyid=7A1C9DA0-0510-44A2-B042-7EF370530C64&amp;displaylang=en">install <span class="caps">MASM</span></a>
(which I think will eventually be included in MozillaBuild, but it isn’t
currently).  Again, just install it with the defaults.</p>
</div>
<div class="section" id="mozillabuild">
<h3><a class="toc-backref" href="#id6">MozillaBuild:</a></h3>
<p>Almost there, I promise.  In order to get a *nix type shell to run
make, etc. in we’ll use a package from Mozilla that includes <span class="caps">MSYS</span>, make,
Mercurial, etc.  Download and <a class="reference external" href="http://ftp.mozilla.org/pub/mozilla.org/mozilla/libraries/win32/MozillaBuildSetup-Latest.exe">install MozillaBuild</a>, the latest should
work fine.</p>
<p>Now, an unknown step: you might require the <a class="reference external" href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=a5c84275-3b97-4ab7-a40d-3802b2af5fc2&amp;displaylang=en">Microsoft Visual C++ 2008
<span class="caps">SP1</span> Redistributable Package</a>.  I don’t know if you need this or not
since I <em>already</em> had it, most likely from a previous program I’ve installed.</p>
<p>We should be ready to build now pretty much.  For some more
information for this stuff you can check out the Mozilla Developer
Network pages I used to get this information: <a class="reference external" href="https://developer.mozilla.org/En/Developer_Guide/Build_Instructions">Build Instructions</a>,
<a class="reference external" href="https://developer.mozilla.org/En/Developer_Guide/Build_Instructions/Windows_Prerequisites">Windows Build Prerequisites</a> and <a class="reference external" href="https://developer.mozilla.org/cn/VC8_Build_Instructions"><span class="caps">MSVC8</span> Build Instructions</a>.</p>
</div>
</div>
<div class="section" id="checkout-the-code">
<h2><a class="toc-backref" href="#id7">Checkout the Code:</a></h2>
<p>We need to checkout the code.  I originally checked out the code with
TortoiseHg (which is what I normally use), but the version of Mercurial
included is significantly greater than the one included in MozillaBuild
and this caused me issues later on.  Thus, we’ll check out the code on
the command line.  Start by launching the bash shell, which is at
C:\mozilla-build\start-msvc8.bat (don’t use the x64 version).  There’s
a version here which corresponds to each version of <span class="caps">VS</span>.</p>
<p>Once this finishes loading you’ll be in the home directory (which is
in the root of your user’s documents and settings folder, i.e. for me:
C:\Users\clokep).  You’ll want to do the following:</p>
<pre class="literal-block">
hg clone https://hg.instantbird.org/instantbird
</pre>
<p>This might take a few minutes depending on how good your internet
connection is.  (The Instantbird source isn’t <span class="caps">THAT</span> big though, it
shouldn’t take too long.)</p>
<p>Then we’ll need to change into the instantbird directory that was just
created and download the Mozilla source code:</p>
<pre class="literal-block">
cd instantbird
python client.py checkout
</pre>
<p>Now this step?  This one is gonna take a while.  It took me like a
couple of hours.  It pulls the Mozilla source code, which is large and
has many changesets.  Just let it go, it’ll give you progress
occasionally (changes, manifests, files, etc.)</p>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id8">Compiling Instantbird:</a></h2>
<p>We need to set up the options we want to build with.  These are
read from a .mozconfig (don’t miss the "." in the front!).  The contents
of the .mozconfig that worked for me are:</p>
<pre class="literal-block">
ac_add_options --enable-application=instantbird
mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/objdir-ib-release
ac_add_options --disable-accessibility
</pre>
<p>The first option says to build Instantbird, the second gives an output
directory and the third <a class="reference external" href="https://developer.mozilla.org/en/atlbase.h">disables accessibility</a> (not really sure why
we need to do this, but we’ll get that error at that link otherwise).</p>
<p>Finally (back in the bash shell) type:</p>
<pre class="literal-block">
make -f client.mk build
</pre>
<p>Now sit back and relax.  My build took about an hour to finish, maybe
a bit less — I wasn’t fully paying attention.  Once it’s done you
should see something like:</p>
<pre class="literal-block">
Processed 1 file, writing output:

Output:
"c:\\Users\\clokep\\instantbird\\objdir-ib-release\\instantbird\\installer\\windows\\instgen\\helper.exe"
Install: 2 pages (128 bytes), 1 section (16416 bytes), 2579
instructions (72212 bytes), 369 strings (10198 bytes), 1 language table (230 bytes).
Uninstall: 5 pages (320 bytes),
1 section (16416 bytes), 2063 instructions (57764 bytes), 388 strings
(10828 bytes), 1 language table (314 bytes).
Datablock optimizer saved 123940 bytes (~17.6%).
Using zlib compression.
EXE header size:               63488 / 39424 bytes
Install code:                  99564 / 99560 bytes
Install data:                 118002 / 241950 bytes
Uninstall code+data:          398654 / 398646 bytes
CRC (0x062AF3F5):                  4 / 4 bytes
Total size:                   679712 / 779584 bytes (87.1%)
c:/Users/clokep/instantbird/objdir-ib-release/mozilla/config/nsinstall.exe -D ../../../mozilla/dist/bin/uninstall
cp instgen/helper.exe ../../../mozilla/dist/bin/uninstall
make[5]: Leaving directory `/c/Users/clokep/instantbird/objdir-ib-release/instantbird/installer/windows'
make[4]: Leaving directory `/c/Users/clokep/instantbird/objdir-ib-release/instantbird'
make[3]: Leaving directory `/c/Users/clokep/instantbird/objdir-ib-release'
make[2]: Leaving directory `/c/Users/clokep/instantbird/objdir-ib-release'
make[1]: Leaving directory `/c/Users/clokep/instantbird/objdir-ib-release'
</pre>
<p>Now, to test that the build actually worked we can browse to the
compiled executable and run it:</p>
<pre class="literal-block">
cd objdir-ib-release/mozilla/dist/bin/instantbird.exe -P dev -no-remote
</pre>
<p>The -P option specifies a profile name (dev), the second option
(-no-remote) allows you to run a second Instantbird instance (since I
assume you use Instantbird to <span class="caps">IM</span>…you probably want to be able to run a
second one, if you don’t use it…shame on you. Try not to close the
wrong Instantbird when you’re working on stuff).</p>
<p>Hopefully this will help someone else get started on hacking
Instantbird.  There’s other good ways you can hack too if your computer
can’t handle compiling, including unpacking omni.jar.</p>
<p>One last tidbit is to possibly add the option to your .mozconfig:</p>
<pre class="literal-block">
--enable-chrome-format=flat
</pre>
<p>This will not package anything in JARs (which pretty much just get in
the way while developing).  See <a class="reference external" href="https://developer.mozilla.org/en/JAR_Packaging">here</a> for more info.</p>
<p>Edit: Fixed the path to the executable thanks to Florian. And fixed a
spelling error in the title.</p>
</div>

    </div><!-- /.entry-content -->

    <div class="comments">
        <h2>2 Comments:</h2>
        <ul id="comments-list">
            <li id="comment-0rst">
                <abbr class="published" title="2011-05-17T05:56:00">
                    Commented: <a href="http://patrick.cloke.us/posts/2011/05/16/compilling-instantbird/#comment-0rst"
                                  rel="bookmark" title="Permalink to this comment">05/17/2011 05:56 AM EST</a>
                </abbr>

                <address class="vcard author">
                    By <a class="url fn" href="http://queze.net/">                        Florian Quèze
</a>                </address>

                <p>First, congratulations for your successful build!&nbsp;:)</p>
<ul class="simple">
<li>I don&#8217;t think you need the &quot;Microsoft Visual C++ 2008 <span class="caps">SP1</span> Redistributable
Package&quot; but it certainly doesn&#8217;t hurt to keep&nbsp;it.</li>
<li>On the buildbot we have <span class="caps">VC2005</span> Pro. The express version won&#8217;t be able to
compile jemalloc (which most likely doesn&#8217;t matter for development&nbsp;builds).</li>
<li>The accessibility error is because you need the Windows 2003 <span class="caps">SDK</span>. Yes, in
addition to the Windows 7 <span class="caps">SDK</span>. Yes, that&#8217;s stupid. Microsoft apparently has a
hard time including all the previously available files in the newer versions
of the <span class="caps">SDK</span>.</li>
<li>The testable executable is in objdir-ib-release/<em>mozilla</em>/dist/bin because of
the comm-central build&nbsp;system.</li>
<li>The flat chrome format is not as useful as it used to be as the new default
chrome format (omnijar) packages the files only during make package and keeps
flat chrome in the dist/bin/chrome&nbsp;folder.</li>
</ul>
<p>Again, congrats! And thanks for documenting&nbsp;this!</p>

                            <ul id="comments-list">
            <li id="comment-1rst">
                <abbr class="published" title="2011-05-19T20:58:00">
                    Commented: <a href="http://patrick.cloke.us/posts/2011/05/16/compilling-instantbird/#comment-1rst"
                                  rel="bookmark" title="Permalink to this comment">05/19/2011 08:58 PM EST</a>
                </abbr>

                <address class="vcard author">
                    By <a class="url fn" href="http://patrick.cloke.us">                        Patrick Cloke
</a>                </address>

                <!--  -->
<blockquote>
First, congratulations for your successful build! :)</blockquote>
<p>Thanks!</p>
<blockquote>
<ul class="simple">
<li>On the buildbot we have <span class="caps">VC2005</span> Pro. The express version won&#8217;t be able to
compile jemalloc (which most likely doesn&#8217;t matter for development&nbsp;builds).</li>
</ul>
</blockquote>
<p>Right, I remember reading that. But it&#8217;s fine for development&nbsp;builds</p>
<blockquote>
<ul class="simple">
<li>The accessibility error is because you need the Windows 2003 <span class="caps">SDK</span>. Yes, in
addition to the Windows 7 <span class="caps">SDK</span>. Yes, that&#8217;s stupid. Microsoft apparently
has a hard time including all the previously available files in the newer
versions of the <span class="caps">SDK</span>.</li>
</ul>
</blockquote>
<p>Bah, that&#8217;s ridiculous. Easier to disable&nbsp;it.</p>
<blockquote>
<ul class="simple">
<li>The testable executable is in objdir-ib-release/<em>mozilla</em>/dist/bin because
of the comm-central build&nbsp;system.</li>
</ul>
</blockquote>
<p>Fixed, thank you.&nbsp;:)</p>
<blockquote>
Again, congrats! And thanks for documenting this!</blockquote>
<p>:)</p>

            </li>
        </ul>

            </li>
        </ul>
    </div>

  </article>
</section>
    </div>

    <footer id="contentinfo" class="body">
        <address id="about" class="vcard body">
        Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
        </address><!-- /#about -->
    </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-52389517-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'clokep';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>